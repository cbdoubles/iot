#include <Servo.h>
#include <SPI.h>
#include <MFRC522.h>

Servo myServo1;
Servo myServo2;
Servo myServo3;

#define SS_PIN 10
#define RST_PIN 9

byte readCard[4];
String MasterTag = "90684726";
String tagID = "";

MFRC522 mfrc522(SS_PIN, RST_PIN);

void setup() {
  Serial.begin(9600);
  while (!Serial);
  SPI.begin();
  mfrc522.PCD_Init();
  //myServo1.attach(5);
  //myServo2.attach(6);
  //myServo3.attach(7);

  //myServo1.write(0);
  //myServo3.write(90);
  pinMode(5, OUTPUT);
  pinMode(4, OUTPUT);
}

void loop() {
  if (Serial.available() > 0) {
    char command = Serial.read();
    Serial.println(command);
    handleSerialCommand(command);
  } else if (getID()) {
    Serial.println(tagID);
    if (tagID == MasterTag){
      while (! Serial.available()) {
      }
      char command = Serial.read();
      handleSerialCommand(command); 
    }
    delay(5000);
    while(Serial.available()) {
      Serial.read();
    }
  }
}

void handleSerialCommand(char command) {  
  if (command == '1') {
    //myServo1.write(180);
    digitalWrite(5, HIGH);
    while(Serial.read() != '1'){
    }
    digitalWrite(5, LOW);
    //myServo1.write(0);
    delay(500);
  } /*
    else if (command == 'B') {
    openServo(myServo2);
    while(Serial.read() != 'B'){
    }
    closeServo(myServo2);
    delay(500);
  } */
  else if (command == '2') {
    //myServo3.write(0);
    digitalWrite(4, HIGH);
    while(Serial.read() != '2'){
    }
    digitalWrite(4, LOW);
    //myServo3.write(90);
    delay(500);
  }
  Serial.flush();
}

boolean getID() {
  if (!mfrc522.PICC_IsNewCardPresent()) {
    return false;
  }
  if (!mfrc522.PICC_ReadCardSerial()) {
    return false;
  }
  tagID = "";

  for ( uint8_t i = 0; i < 4; i++) {
  tagID.concat(String(mfrc522.uid.uidByte[i], HEX));
  }
  tagID.toUpperCase();

  mfrc522.PICC_HaltA();
  return true;
}

void openServo(Servo servo) {
  servo.write(0); // Move the servo to the desired position (adjust as needed)
}

void closeServo(Servo servo){
  servo.write(240);
}
